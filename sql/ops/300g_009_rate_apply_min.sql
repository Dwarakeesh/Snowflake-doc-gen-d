CREATE OR REPLACE PROCEDURE AI_FEATURE_HUB.APPLY_RATE_TO_USAGE(billing_date DATE) RETURNS VARIANT LANGUAGE SQL AS $$ INSERT INTO AI_FEATURE_HUB.BILLING_LINE_ITEM(LINE_ID,INVOICE_ID,ACCOUNT_ID,FEATURE_KEY,UNITS,UNIT_PRICE,LINE_TOTAL,CURRENCY,DESCRIPTION) SELECT RANDOM(), 'INVOICE_PLACEHOLDER',u.account_id,u.feature_key,u.units_sum,r.base_unit_price,(u.units_sum*r.base_unit_price), 'USD', 'Usage for '||u.usage_date FROM AI_FEATURE_HUB.USAGE_DAILY_SELECT u JOIN AI_FEATURE_HUB.V_RATECARD_CURRENT r ON r.feature_key=u.feature_key WHERE u.usage_date = :1; $$;