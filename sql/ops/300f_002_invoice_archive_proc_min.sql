CREATE OR REPLACE PROCEDURE AI_FEATURE_HUB.ARCHIVE_OLD_INVOICES(days NUMBER, batch_size NUMBER) RETURNS VARIANT LANGUAGE SQL AS $$ MERGE INTO AI_FEATURE_HUB.INVOICE_ARCHIVE a USING (SELECT invoice_id,account_id,total,currency,created_at FROM AI_FEATURE_HUB.SUBSCRIPTION_INVOICES WHERE created_at < DATEADD(day,-:1,current_timestamp()) LIMIT :2) s ON a.invoice_id = s.invoice_id WHEN NOT MATCHED THEN INSERT (invoice_id,account_id,subtotal,markup,tax,total,currency,archived_at) VALUES (s.invoice_id,s.account_id,s.total*0.9,0.1,0,s.total,s.currency,CURRENT_TIMESTAMP()); RETURN 'OK'; $$;