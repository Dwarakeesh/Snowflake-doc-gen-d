CREATE OR REPLACE PROCEDURE AI_FEATURE_HUB.TRANSFORM_AND_ENRICH_USAGE() RETURNS VARIANT LANGUAGE SQL AS $$ insert into AI_FEATURE_HUB.TENANT_FEATURE_USAGE(USAGE_ID,ACCOUNT_ID,FEATURE_KEY,UNITS,UNIT_PRICE,USAGE_TIMESTAMP,METADATA) select value:usageId::string,value:account::string,value:feature::string,value:units::number,value:unit_price::number,to_timestamp_ltz(value:ts::string),value:meta::variant from (select parse_json(usage_json):[0] value from AI_FEATURE_HUB.USAGE_RAW where INGESTED_AT>dateadd(minute,-10,current_timestamp())); return 'ok'; $$;