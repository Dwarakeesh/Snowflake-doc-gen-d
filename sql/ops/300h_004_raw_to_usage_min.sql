CREATE OR REPLACE PROCEDURE AI_FEATURE_HUB.TRANSFORM_RAW_TO_USAGE() RETURNS VARIANT LANGUAGE SQL AS $$ INSERT INTO AI_FEATURE_HUB.TENANT_FEATURE_USAGE(USAGE_ID,ACCOUNT_ID,FEATURE_KEY,UNITS,UNIT_PRICE,USAGE_TIMESTAMP,METADATA) SELECT RAW.RAW_ID,RAW.RAW_PAYLOAD:accountId::STRING,RAW.RAW_PAYLOAD:feature::STRING,COALESCE(RAW.RAW_PAYLOAD:units::NUMBER,1),COALESCE(RAW.RAW_PAYLOAD:unitPrice::NUMBER,0.0),RAW.INGESTED_AT,RAW.RAW_PAYLOAD FROM AI_FEATURE_HUB.USAGE_RAW RAW WHERE RAW.RAW_PAYLOAD IS NOT NULL; RETURN 'ok'; $$;
GRANT EXECUTE ON PROCEDURE AI_FEATURE_HUB.TRANSFORM_RAW_TO_USAGE TO ROLE YOUR_RUN_ROLE;