CREATE OR REPLACE PROCEDURE AI_FEATURE_HUB.UPSERT_USAGE_FROM_RAW() RETURNS VARIANT LANGUAGE SQL AS $$ merge into AI_FEATURE_HUB.TENANT_FEATURE_USAGE t using (select parse_json(raw):account::string account,parse_json(raw):feature::string feature,parse_json(raw):units::number units,parse_json(raw):unit_price::number unit_price, to_timestamp_ltz(parse_json(raw):ts::string) ts, parse_json(raw):id::string evtid from AI_FEATURE_HUB.USAGE_RAW where ingested_at>dateadd(minute,-10,current_timestamp())) s on t.usage_id=s.evtid when matched then update set units=s.units,unit_price=s.unit_price,usage_timestamp=s.ts when not matched then insert(usage_id,account_id,feature_key,units,unit_price,usage_timestamp,metadata) values(s.evtid,s.account,s.feature,s.units,s.unit_price,s.ts,parse_json('{}')); $$;